
{% extends 'cart_items/cart_base.html' %}


{% load static %}

{% block body %}

	<!-- top Products -->
	<div class="ads-grid_shop">
		<div class="shop_inner_inf">
			<div class="privacy about">
				<h3>Chec<span>kout</span></h3>
				{% if cart_items %}
				<div class="checkout-right">
					<h4>Your shopping cart contains: <span>3 Products</span></h4>
					<table class="timetable_sub">
						<thead>
							<tr>
								<!-- <th>SL No.</th> -->
								<th style="width:35%">Product</th>
								<th>Quantity</th>
								<th>Product Name</th>
								<th>Color</th>
								<th>Size</th>
								<th>Price</th>
								<th>Remove</th>
							</tr>
						</thead>
						<tbody>
							{% for cart_item in cart_items %}
							<tr class="rem1" {{ forloop.counter }}>
								<!-- <td class="invert">1</td> -->
								<td class="invert-image"><a href="single.html"><img src="{{ cart_item.product.colors.image_1.url }}" style="width:15%" alt=" " class="img-responsive"></a></td>
								<td class="invert">
									<div class="quantity">
										<div class="quantity-select">
											<div class="entry value-minus">&nbsp;</div>
											<!-- <div class="entry value" data-price="{{ cart_item.product.name.product_price }}" data-quantity="{{ cart_item.quantity }}"></div> -->
											<div class="entry value"><span>{{ cart_item.quantity }}</span></div>
											<div hidden class="cart-item-id">{{cart_item.id}}</div>
											<div class="entry value-plus active">&nbsp;</div>
										</div>
									</div>
								</td>
								<td class="invert">{{cart_item.product.name.product_name}}</td>

								<td class="invert">{{ cart_item.product.colors.colors }}</td>
								<td class="invert">{{ cart_item.product.size.size_number }}</td>
								<!-- <td class="invert" >{{ cart_item.product.name.product_price }}</td> -->
								<td class="invert" >
									<span class="price" id="price-{{ forloop.counter }}">{{ cart_item.get_subtotal }}</span>
								</td>


								<td class="invert">
									<div class="rem">
										<!-- <a href="{% url 'delete_cart_item' cart_item.id %}">Delete</a> -->

										<form id="delete-cart-item-form" method="post" action="{% url 'delete_cart_item' cart_item.id %}">
											{% csrf_token %}
											<input type="submit" value="" class="close1" style="border: none;">
											
										  </form>
									</div>

								</td>
								<script>
									document.getElementById('delete-cart-item-form').addEventListener('submit', function(event) {
									  event.preventDefault();
									  var confirmed = confirm('Are you sure you want to delete the cart item?');
									  if (confirmed) {
										this.submit();
									  }
									});
									
									document.getElementById('cancel-delete').addEventListener('click', function() {
									  window.history.back();
									});
									</script>
							</tr>
							{% endfor %}
							

						</tbody>
					</table>
					<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
				
					<script>

						// Get all the quantity-select elements
						const quantitySelects = document.querySelectorAll('.quantity-select');

						// Loop through each quantity-select element
						quantitySelects.forEach((quantitySelect) => {
							// Get the value element within the current quantity-select
							const valueElement = quantitySelect.querySelector('.value span');

							// Get the id of the cart item
							const cartItemIdElement = quantitySelect.querySelector('.cart-item-id');

							// Get the value-minus and value-plus buttons within the current quantity-select
							const minusButton = quantitySelect.querySelector('.value-minus');
							const plusButton = quantitySelect.querySelector('.value-plus');

							// Get the price element within the current quantity-select
							const priceElement = quantitySelect.parentElement.querySelector('.product-price');

							// Function to increment the value and update the price
							function incrementValue() {
								let value = parseInt(valueElement.textContent);
								value++;
								valueElement.textContent = value;
								const cartItemId = parseInt(cartItemIdElement.innerText);
								sendUpdatedData(cartItemId, value);
								updatePrice();
							}

							// Function to decrement the value and update the price
							function decrementValue() {
								let value = parseInt(valueElement.textContent);
								if (value > 1) {
									value--;
									valueElement.textContent = value;
									const cartItemId = parseInt(cartItemIdElement.innerText);
									sendUpdatedData(cartItemId, value);
									updatePrice();
								}
							}

							// Function to update the price based on the quantity
							function updatePrice() {
								const pricePerUnit = parseFloat(priceElement.textContent);
								let value = parseInt(valueElement.textContent);
								let totalPrice = value * pricePerUnit;
								priceElement.textContent = totalPrice.toFixed(2);
							}

							// Add click event listeners to the buttons within the current quantity-select
							minusButton.addEventListener('click', decrementValue);
							plusButton.addEventListener('click', incrementValue);

							const sendUpdatedData = async (id, quantity) => {
								console.log(`Updating id: ${id}, quantity: ${quantity}`);
								
								const formData = new FormData();
								formData.set('csrfmiddlewaretoken', '{{ csrf_token }}');
								formData.set('id', id);
								formData.set('quantity', quantity);
								const response = await fetch('/cart_items/update_cart_item', {
									method: 'POST',
									body: formData,
								});
								const resBody = await response.text();
								if(resBody === 'OK') {
									window.location.reload();
									return; 
								}
								console.log(resBody);
								
							}
							
						});
					</script> 
				</div>
				{% else %}
				<br><br>
				<h4>No items added</h4>
				{% endif %}
				<div class="checkout-left">
					<div class="col-md-4 checkout-left-basket" style="width:40%;float:right;margin-top:3rem;">
						<h4 style="background:grey;">Continue to basket</h4>
						<ul>
							{% for cart_item in cart_items %}
							<li>
								<div>
									<div>
										<i>{{cart_item.product.name.product_name}}</i>
										<span>${{ cart_item.get_subtotal }}.00</span>
										<span style=" margin-right: 10rem;">{{ cart_item.quantity }} No.s</span> 
										
									</div>
								</div>
								 </li>
							
							{% endfor %}
							<br>
							<br>
							<li>Total <i>-</i> <span>${{ total_amount }}.00</span></li>
						</ul>
						<h4>Choose Address</h4>
					</div>
					 

					<div class="clearfix"> </div>


					<div class="clearfix"></div>
				</div>
			</div>
		</div>
		<br>
		<br>
		<br>
{% endblock %}